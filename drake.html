<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure P2P Chatroom</title>
  <style>
    body { background: #111; color: #0f0; font-family: monospace; padding: 10px; }
    textarea, input { width: 100%; background: #000; color: #0f0; border: 1px solid #0f0; margin: 5px 0; padding: 5px; }
    button { background: #0f0; color: #000; padding: 5px; border: none; margin-top: 5px; cursor: pointer; }
    #chat { height: 300px; overflow-y: scroll; background: #000; padding: 5px; border: 1px solid #0f0; margin-bottom: 10px; }
    img.chat-image { max-width: 100%; max-height: 150px; margin-top: 5px; }
  </style>
</head>
<body>

<h2>P2P Secure Chatroom</h2>

<div>
  <label>Session Key:</label>
  <input type="password" id="key">
  <button onclick="joinChat()">Join</button>
</div>

<div id="chat"></div>

<textarea id="msg" placeholder="Type your message..." disabled></textarea>
<button onclick="sendMessage()" id="sendBtn" disabled>Send</button>
<input type="file" id="imgInput" accept="image/*" disabled>
<button onclick="sendImage()" id="sendImgBtn" disabled>Send Image</button>

<div>
  <button onclick="nuke()">NUKE</button>
  <button onclick="toggleHost()" id="hostToggle">Become Host</button>
</div>

<script>
let keyCache = null;
let isHost = false;
let joined = false;

async function deriveKey(pw) {
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey(
    "raw", enc.encode(pw), "PBKDF2", false, ["deriveKey"]
  );
  return crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: enc.encode("secureChatRoom"),
      iterations: 100000,
      hash: "SHA-256"
    },
    baseKey,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
}

async function encryptMessage(msg, key) {
  const enc = new TextEncoder();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv: iv }, key, enc.encode(msg)
  );
  return btoa([...iv, ...new Uint8Array(ct)].map(b => String.fromCharCode(b)).join(""));
}

async function decryptMessage(blob, key) {
  const raw = Uint8Array.from(atob(blob), c => c.charCodeAt(0));
  const iv = raw.slice(0, 12);
  const ct = raw.slice(12);
  const pt = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv: iv }, key, ct
  );
  return new TextDecoder().decode(pt);
}

async function joinChat() {
  const keyStr = document.getElementById("key").value;
  if (!keyStr) return alert("Please enter a session key.");
  keyCache = await deriveKey(keyStr);
  document.getElementById("msg").disabled = false;
  document.getElementById("sendBtn").disabled = false;
  document.getElementById("imgInput").disabled = false;
  document.getElementById("sendImgBtn").disabled = false;
  joined = true;
  displayMessage("System", "You have joined the chat.");
}

async function sendMessage() {
  const input = document.getElementById("msg");
  if (!joined || !keyCache || !input.value) return;
  const encrypted = await encryptMessage(input.value, keyCache);
  displayMessage("You", input.value);
  input.value = "";
  simulateP2PSend(encrypted, 'text');
}

async function sendImage() {
  const fileInput = document.getElementById("imgInput");
  if (!joined || !keyCache || fileInput.files.length === 0) return;
  const reader = new FileReader();
  reader.onload = async () => {
    const base64Image = reader.result;
    const encrypted = await encryptMessage("[img]" + base64Image, keyCache);
    displayImage("You", base64Image);
    simulateP2PSend(encrypted, 'image');
  };
  reader.readAsDataURL(fileInput.files[0]);
  fileInput.value = "";
}

function displayMessage(user, text) {
  const chat = document.getElementById("chat");
  chat.innerHTML += `<div><b>${user}:</b> ${text}</div>`;
  chat.scrollTop = chat.scrollHeight;
}

function displayImage(user, base64) {
  const chat = document.getElementById("chat");
  chat.innerHTML += `<div><b>${user}:</b><br><img src="${base64}" class="chat-image"></div>`;
  chat.scrollTop = chat.scrollHeight;
}

function simulateP2PSend(encrypted, type) {
  setTimeout(async () => {
    if (!keyCache) return;
    const fakeTraffic = Math.random() < 0.2;
    if (fakeTraffic) {
      displayMessage("Dummy", "<noise>");
      return;
    }
    try {
      const decrypted = await decryptMessage(encrypted, keyCache);
      if (decrypted.startsWith("[img]")) {
        displayImage("Peer", decrypted.slice(5));
      } else {
        displayMessage("Peer", decrypted);
      }
    } catch (e) {
      displayMessage("Error", "Decryption failed.");
    }
  }, Math.random() * 1000);
}

function nuke() {
  keyCache = null;
  joined = false;
  document.getElementById("key").value = "";
  document.getElementById("msg").value = "";
  document.getElementById("chat").innerHTML = "<i>Chat nuked</i><br>";
  document.getElementById("msg").disabled = true;
  document.getElementById("sendBtn").disabled = true;
  document.getElementById("imgInput").disabled = true;
  document.getElementById("sendImgBtn").disabled = true;
}

function toggleHost() {
  isHost = !isHost;
  document.getElementById("hostToggle").textContent = isHost ? "Revoke Host" : "Become Host";
  displayMessage("System", isHost ? "You are now the host." : "You are no longer the host.");
}
</script>

</body>
</html>
